<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SoroPG</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/13.1.0/stellar-sdk.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stellar-freighter-api/4.1.0/index.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --bg-dark: #1e1e1e;
      --bg-darker: #121212;
      --bg-menu: #252526;
      --accent-color: #9e8cfc;
      --text-light: #e0e0e0;
      --text-dim: #9e9e9e;
      --section-bg: #2d2d2d;
      --border-color: #3e3e3e;
    }
    
    html, body { 
      margin: 0; 
      height: 100%; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-light);
      overflow: hidden;
    }
    
    .container {
      display: flex;
      height: 100%;
    }

    .accent {
      color: var(--accent-color);
    }

    .sidebar {
      width: 50px;
      height: 100%;
      background-color: var(--bg-menu);
      display: flex;
      flex-direction: column;
      align-items: center;
      border-right: 1px solid var(--border-color);
    }
    
    .sidebar-icon {
      width: 50px;
      height: 50px;
      display: flex;
      justify-content: center;
      align-items: center;
      color: var(--text-dim);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .sidebar-icon:hover {
      color: var(--text-light);
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .sidebar-icon.active {
      color: var(--text-light);
      border-left: 3px solid var(--accent-color);
    }
    
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    
    #header-container {
      height: 20px;
      text-align: right;
      margin: 5px;
    }

    #header-container a {
        font-size: 0.6em;
        color: #AAA;
        text-decoration: none;
        padding: 3px 8px;
    }

    #editor-container {
      height: 62%;
      border-bottom: 1px solid var(--border-color);
    }
    
    #editor {
      height: 100%;
      width: 100%;
    }
    
    .panel-container {
      height: 38%;
      background-color: var(--section-bg);
      overflow-y: auto;
    }
    
    .panel {
      padding: 20px;
      display: none;
      height: 100%;
      box-sizing: border-box;
    }
    
    .panel.active {
      display: block;
    }

    .dim {
      color: var(--text-dim);
    }
    
    button {
      background-color: var(--accent-color);
      color: black;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s;
    }
    
    button:hover {
      background-color: #f8d93c;
    }
    
    #status {
      margin-left: 10px;
      color: var(--text-light);
    }
    
    h1 {
      margin-top: 0;
      color: var(--text-light);
      font-size: 24px;
    }

    .console {
      background: #000;
      color: #0f0;
      padding: 10px;
      font-family: monospace;
      height: 200px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      margin-top: 10px;
    }
    
  </style>
</head>
<body>
  <div class="container">
    <!-- Sidebar Menu -->
    <div class="sidebar">
      <div class="sidebar-icon" data-panel="home" title="Home">
        <svg width="321.97" height="361.23" version="1.1" viewBox="0 0 85.189 95.575" xml:space="preserve" xmlns="http://www.w3.org/2000/svg"><g transform="translate(-208.43 -67.328)"><path d="m242.66 77.712c-0.70187 0.0092-1.3963 0.04598-2.0771 0.11164-4.2065 0.4057-7.4589 1.4372-11.181 3.5462-1.8228 1.0327-1.9404 1.1378-1.6147 1.4436 0.1932 0.18141 2.5416 1.9132 5.2183 3.8487 5.9229 4.2827 20.982 15.208 26.509 19.231 5.8797 4.2804 6.714 4.7281 10.044 5.3911 1.7888 0.3561 5.684 0.23577 7.4556-0.23016 3.1066-0.81705 6.108-2.864 6.9649-4.7504 0.5234-1.1522 0.51331-3.2372-0.0211-4.3394-0.66513-1.372-1.3432-1.9591-6.9654-6.0346-2.9498-2.1383-8.5318-6.1888-12.405-9.0007-3.8728-2.8119-7.5339-5.4152-8.1359-5.785-3.5956-2.2091-8.8788-3.4966-13.792-3.4321zm-17.122 7.5786-1.6293 1.6293c-2.8137 2.8137-4.1228 5.6189-4.3082 9.2321-0.13483 2.6279 0.38519 4.7336 1.7401 7.0483 1.5304 2.6144 3.1806 4.0437 12.182 10.549 4.5562 3.2928 8.9364 6.4678 9.7337 7.0555 0.79733 0.58773 4.3853 3.1955 7.9733 5.7952 12.642 9.1597 16.3 11.814 20.6 14.951l4.3422 3.1676 1.2159-1.1916c0.66855-0.65537 1.6284-1.7648 2.1333-2.4658 1.8058-2.5072 2.569-4.8285 2.5637-7.7966-4e-3 -2.2389-0.43528-3.974-1.497-6.0237-1.4825-2.8619-3.1208-4.2876-13.825-12.031-10.917-7.8976-26.452-19.166-35.161-25.506zm4.0894 33.356c-2.9577-0.0543-5.8774 0.64752-8.3689 2.073-2.4192 1.3842-3.5668 3.1004-3.5745 5.3454-5e-3 1.5821 0.47845 2.7348 1.6139 3.8455 0.41983 0.4107 4.0251 3.1117 8.0118 6.0022 3.9867 2.8906 9.625 6.9839 12.53 9.0966 6.6484 4.8358 7.9277 5.5323 12.219 6.6511 3.1287 0.81567 6.2152 1.046 9.5565 0.71311 4.0008-0.39861 7.4254-1.4975 11.029-3.5393 1.8247-1.0338 1.9404-1.1377 1.6143-1.4452-0.1932-0.18225-2.5412-1.9144-5.2179-3.8495-4.3431-3.1398-14.896-10.793-26.545-19.251-4.9882-3.6217-5.7505-4.0962-7.587-4.7208-1.7178-0.58425-3.506-0.88886-5.2806-0.92144z" fill="#9e8cfc" stop-color="#000000" stroke-linecap="square" stroke-width="4.1211" style="paint-order:stroke fill markers"/></g></svg>
      </div>
      <div class="sidebar-icon active" data-panel="create" title="Create">
        <i class="fas fa-file-code fa-lg"></i>
      </div>
      <div class="sidebar-icon" data-panel="build" title="Build">
        <i class="fas fa-hammer fa-lg"></i>
      </div>
      <div class="sidebar-icon" data-panel="test" title="Test">
        <i class="fas fa-vial fa-lg"></i>
      </div>
      <div class="sidebar-icon" data-panel="deploy" title="Deploy">
        <i class="fas fa-rocket fa-lg"></i>
      </div>
      <div class="sidebar-icon" data-panel="github" title="Github">
        <i class="fa-brands fa-github fa-lg"></i>
      </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
      <div id="header-container">
        <a href="https://lab.stellar.org/" target="_blank">LAB</a>
        <a href="https://stellar.expert/" target="_blank">EXPLORER</a>
        <a href="https://jamesbachini.github.io/Soroban-Dev-Tools/" target="_blank">TOOLS</a>
        <a href="https://developers.stellar.org/" target="_blank">DOCS</a>
        -
        <a href="/" target="_blank">SoroPG v0.0.2</a>
      </div>
      <!-- Editor -->
      <div id="editor-container">
        <div id="editor"></div>
      </div>
      
<!-- Panels -->
<div class="panel-container">
  <div class="panel active" id="create-panel">
    <h1><i class="fas fa-file-code accent"></i> Create</h1>
    <div class="panel-content">
      <div class="welcome-message">
        <h2 class="accent">Welcome To The Soroban Playground</h2>
        <p>This IDE allows you to write, build, test, and deploy Soroban smart contracts directly in your browser.</p>
      </div>
      
      <div class="info-card">
        <h3>Getting Started</h3>
        <p>Use the editor above to write your Rust smart contract. The template already includes a basic contract structure to help you get started.</p>
        <p>Navigate between different stages of development using the icons in the left sidebar:</p>
        <ul>
          <li><i class="fas fa-file-code"></i> <strong>Create</strong> - Write your smart contract code</li>
          <li><i class="fas fa-hammer"></i> <strong>Build</strong> - Compile your contract to WASM</li>
          <li><i class="fas fa-vial"></i> <strong>Test</strong> - Verify your contract functionality</li>
          <li><i class="fas fa-rocket"></i> <strong>Deploy</strong> - Deploy your contract to the network</li>
        </ul>
      </div>
      
      <div class="quick-tips dim">
        <h3>Quick Tips</h3>
        <div class="tip">
          <i class="fas fa-lightbulb"></i>
          <span>Use <code>#![no_std]</code> at the beginning of your contract to indicate that the Rust standard library is not available in the WASM environment.</span>
        </div>
        <div class="tip">
          <i class="fas fa-lightbulb"></i>
          <span>Import the Soroban SDK with <code>use soroban_sdk::{contract, contractimpl, Env};</code> to access the contract development tools.</span>
        </div>
        <div class="tip">
          <i class="fas fa-lightbulb"></i>
          <span>The <code>#[contract]</code> and <code>#[contractimpl]</code> macros are used to define your contract structure and implementation.</span>
        </div>
      </div>
    </div>
  </div>

  <div class="panel" id="build-panel">
    <h1><i class="fas fa-hammer accent"></i> Build</h1>
    <div class="panel-content">
      <div class="info-card">
        <h3>Compile Your Contract to WASM</h3>
        <p>Click the button below to compile your Rust smart contract to WebAssembly (WASM). This will transform your code into a binary format that can be executed on the Soroban platform.</p>
        <p>The compilation process:</p>
        <ol>
          <li>Validates your Rust code syntax</li>
          <li>Checks for contract compatibility with Soroban SDK</li>
          <li>Generates optimized WASM bytecode</li>
          <li>Provides a downloadable WASM file when successful</li>
        </ol>
      </div>
      
      <div class="build-controls">
        <button onclick="compileCode()" class="primary-button">
          <i class="fas fa-cogs"></i> Compile to WASM
        </button>
        <span id="build-status"></span>
      </div>
      
      <div class="build-tips dim">
        <div class="tip">
          <i class="fas fa-info-circle"></i>
          <span>Compilation might take a few seconds depending on the complexity of your contract.</span>
        </div>
        <div class="tip">
          <i class="fas fa-file-download"></i>
          <span>The compiled WASM file will automatically download when compilation is successful.</span>
        </div>
      </div>
    </div>
  </div>

  <div class="panel" id="test-panel">
    <h1><i class="fas fa-vial accent"></i> Test</h1>
    <div class="panel-content">
      <div class="info-card">
        <h3>Testing Your Smart Contract</h3>
        <p>In this section, you can test your smart contract functionality before deployment. Writing tests helps ensure your contract behaves as expected under various conditions.</p>
      </div>
      
      <div class="build-controls">
        <button onclick="runTests()"><i class="fas fa-play"></i> Run Unit Tests</button>
        <span id="test-status"></span>
      </div>
      <div id="test-console" class="console"></div>
      
      <div class="test-tips">
        <h3>Testing Best Practices</h3>
        <div class="tip">
          <i class="fas fa-check-circle"></i>
          <span>Test each function individually to isolate potential issues.</span>
        </div>
        <div class="tip">
          <i class="fas fa-check-circle"></i>
          <span>Include edge cases and boundary conditions in your tests.</span>
        </div>
        <div class="tip">
          <i class="fas fa-check-circle"></i>
          <span>Verify that your contract handles errors gracefully.</span>
        </div>
      </div>
    </div>
  </div>

  <div class="panel" id="deploy-panel">
    <h1><i class="fas fa-rocket accent"></i> Deploy</h1>
    <div class="panel-content">
      <div class="info-card">
        <h3>Deploy Your Contract</h3>
        <p>After successfully building and testing your smart contract, you can deploy it to the Soroban network. Deployment makes your contract accessible to users and other contracts.</p>
      </div>
      
      <div class="deploy-controls">
        <label for="network">Select Network:</label>
        <select id="network">
          <option value="TESTNET" selected>Testnet</option>
          <option value="PUBLIC">Mainnet</option>
        </select>
      
        <br/><br/>
      
        <button id="connect-button">Connect Freighter Wallet</button>
        <div id="wallet-info"></div>
      
        <br/>
        <button id="deploy-button" disabled>Deploy WASM</button>
      
        <div id="deploy-console" class="console"></div>
      </div>
      
      <div class="deploy-tips">
        <h3>Deployment Tips</h3>
        <div class="tip">
          <i class="fas fa-coins"></i>
          <span>Deploying a contract requires XLM to cover network fees.</span>
        </div>
        <div class="tip">
          <i class="fas fa-server"></i>
          <span>Consider deploying to testnet first for additional verification.</span>
        </div>
        <div class="tip">
          <i class="fas fa-shield-alt"></i>
          <span>Once deployed, contract code cannot be changed, only upgraded through specified mechanisms.</span>
        </div>
      </div>
    
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
  <script>
    let editor;
    let publicKey = null;
    let rpc;
    let horizon;
    let networkPassphrase;
    let network = 'TESTNET';

    require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' } });
    require(['vs/editor/editor.main'], function () {
      editor = monaco.editor.create(document.getElementById('editor'), {
        value: `#![no_std]

use soroban_sdk::{contract, contractimpl, Env};

#[contract]
pub struct ExampleContract;

#[contractimpl]
impl ExampleContract {
    pub fn add(_env: Env, a: i32, b: i32) -> i32 {
        a + b
    }
}

#[cfg(test)]

#[test]
fn example_unit_test() {
    let env = Env::default();
    let contract_id = env.register(ExampleContract, ());
    let client = ExampleContractClient::new(&env, &contract_id);
    let a = 5_i32;
    let b = 7_i32;
    let result = client.add(&a, &b);
    assert_eq!(result, 12);
}
`,
        language: 'rust',
        theme: 'vs-dark',
        automaticLayout: true,
        fontSize: 14,
        minimap: {
          enabled: true
        }
      });
    });

    async function compileCode() {
      const code = editor.getValue();
      document.getElementById('build-status').innerText = 'Compiling...';

      const response = await fetch('/compile', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code })
      });

      if (response.ok) {
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'project.wasm';
        a.click();
        document.getElementById('build-status').innerText = 'Compilation successful!';
      } else {
        const error = await response.text();
        document.getElementById('build-status').innerText = `Error: ${error}`;
      }
    }

    async function runTests() {
      const code = editor.getValue();
      document.getElementById('test-status').innerText = 'Running tests...';
      const consoleEl = document.getElementById('test-console');
      consoleEl.innerText = '';
      try {
        const response = await fetch('/test', {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ code })
        });
        const result = await response.text();
        consoleEl.innerText = result;
        document.getElementById('test-status').innerText = response.ok ? 'Tests completed' : 'Errors in tests';
      } catch (err) {
        consoleEl.innerText = err.message;
        document.getElementById('test-status').innerText = 'Test runner error';
      }
    }

    // Deployment
    function updateNetwork(value) {
      network = value;
      let rpcURL;
      let horizonURL;
      if (network == 'TESTNET') {
        rpcURL = 'https://soroban-testnet.stellar.org';
        horizonURL = 'https://horizon-testnet.stellar.org'; 
        networkPassphrase = StellarSdk.Networks.TESTNET;
      } else {
        rpcURL = 'https://mainnet.sorobanrpc.com';
        horizonURL = 'https://horizon.stellar.org'; 
        networkPassphrase = StellarSdk.Networks.PUBLIC;
      }
      rpc = new StellarSdk.rpc.Server(rpcURL);
      horizon = new StellarSdk.Horizon.Server(horizonURL);
    }

    updateNetwork(document.getElementById('network').value);
    document.getElementById('network').addEventListener('change', (e) => {
      updateNetwork(e.target.value);
      document.getElementById('deploy-console').textContent += `Network switched to ${network}`;
    });

    // Connect to Freighter
    document.getElementById('connect-button').addEventListener('click', async () => {
      if (!window.freighterApi) {
        alert('Freighter extension is not installed.');
        return;
      }

      const isAppConnected = await window.freighterApi.isConnected();

      if (!isAppConnected.isConnected) {
          alert("Please download Freighter Wallet");
      }

      const retrievePublicKey = async () => {
          const accessObj = await window.freighterApi.requestAccess();
          if (accessObj.error) {
              throw new Error(accessObj.error.message);
          } else {
              return accessObj.address;
          }
      };

      publicKey = await retrievePublicKey();
      document.getElementById('wallet-info').textContent = `Connected: ${publicKey}`;
      document.getElementById('deploy-button').disabled = false;
    });


    document.getElementById('deploy-button').addEventListener('click', async () => {
      if (!publicKey) {
        alert('Please connect your wallet first.');
        return;
      }

      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.wasm';
      input.click();

      input.onchange = async () => {
        const file = input.files[0];
        if (!file) return;

        const wasmBuffer = new Uint8Array(await file.arrayBuffer());

        try {
    
          const sourceAccount = await horizon.loadAccount(publicKey);
          const op = StellarSdk.Operation.uploadContractWasm({ wasm: wasmBuffer });
          const tx = new StellarSdk.TransactionBuilder(sourceAccount, {
            fee: StellarSdk.BASE_FEE,
            networkPassphrase: network === 'TESTNET'
              ? StellarSdk.Networks.TESTNET
              : StellarSdk.Networks.PUBLIC,
          })
          .addOperation(op)
          .setTimeout(30)
          .build();
          const preparedTx = await rpc.prepareTransaction(tx);
          const xdr = preparedTx.toXDR();
          document.getElementById('deploy-console').textContent += 'Requesting signature 1/2 from Freighter...';
          const signedXDR = await window.freighterApi.signTransaction(xdr, {
            network,
            networkPassphrase: network === 'TESTNET'
              ? StellarSdk.Networks.TESTNET
              : StellarSdk.Networks.PUBLIC,
            address: publicKey
          });
          const signedTx = StellarSdk.TransactionBuilder.fromXDR(signedXDR.signedTxXdr, network === 'TESTNET'
              ? StellarSdk.Networks.TESTNET
              : StellarSdk.Networks.PUBLIC);
          document.getElementById('deploy-console').textContent += 'Submitting transaction 1/2...';
          let response = await rpc.sendTransaction(signedTx);
          const hash = response.hash;
          document.getElementById('deploy-console').textContent += `Transaction 1/2 Submitted (hash: ${hash}). Waiting for confirmation...`;

          // Poll for result
          while (true) {
            response = await rpc.getTransaction(hash);
            if (response.status !== 'NOT_FOUND') break;
            await new Promise((resolve) => setTimeout(resolve, 1000));
          }

          if (response.status === 'SUCCESS') {
            const wasmHash = response.returnValue.bytes();
            const salt = response.returnValue.hash;
            document.getElementById('deploy-console').textContent += `Success! WASM hash: ${wasmHash.toString('hex')}`;
            const op2 = StellarSdk.Operation.createCustomContract({
              wasmHash,
              address: StellarSdk.Address.fromString(publicKey),
              salt,
            });
            const tx2 = new StellarSdk.TransactionBuilder(sourceAccount, {
              fee: StellarSdk.BASE_FEE,
              networkPassphrase: network === 'TESTNET'
                ? StellarSdk.Networks.TESTNET
                : StellarSdk.Networks.PUBLIC,
            })
            .addOperation(op2)
            .setTimeout(30)
            .build();
            const preparedTx2 = await rpc.prepareTransaction(tx2);
            const xdr2 = preparedTx2.toXDR();
            document.getElementById('deploy-console').textContent += 'Requesting signature 2/2 from Freighter...';
            const signedXDR2 = await window.freighterApi.signTransaction(xdr2, {
              network,
              networkPassphrase: network === 'TESTNET'
                ? StellarSdk.Networks.TESTNET
                : StellarSdk.Networks.PUBLIC,
              address: publicKey
            });
            const signedTx2 = StellarSdk.TransactionBuilder.fromXDR(signedXDR2.signedTxXdr, network === 'TESTNET'
                ? StellarSdk.Networks.TESTNET
                : StellarSdk.Networks.PUBLIC);
            document.getElementById('deploy-console').textContent += 'Submitting transaction 2/2 ...';
            let response2 = await rpc.sendTransaction(signedTx2);
            const hash2 = response2.hash;
            document.getElementById('deploy-console').textContent += `Transaction 2/2 Submitted (hash: ${hash2}). Waiting for confirmation...`;
            while (true) {
              response2 = await rpc.getTransaction(hash2);
              if (response2.status !== 'NOT_FOUND') break;
              await new Promise((resolve) => setTimeout(resolve, 1000));
            }

            if (response2.status === 'SUCCESS') {
              const contractAddress = StellarSdk.StrKey.encodeContract(
                StellarSdk.Address.fromScAddress(
                  response2.returnValue.address(),
                ).toBuffer(),
              );
              document.getElementById('deploy-console').textContent += `Contract Deployed! ${contractAddress}`;
            
            } else {
              document.getElementById('deploy-console').textContent += 'Transaction 2/2 failed.';
            }
          } else {
            document.getElementById('deploy-console').textContent += 'Transaction 1/2 failed.';
          }

        } catch (err) {
          console.error(err);
          document.getElementById('status').textContent += 'Error: ' + err.message;
        }
      };
    });

    // Handle sidebar navigation
    document.querySelectorAll('.sidebar-icon').forEach(icon => {
      icon.addEventListener('click', function() {
        const panelId = this.getAttribute('data-panel') + '-panel';

        if (panelId == 'home-panel') window.location = "/";
        if (panelId == 'github-panel') window.location = "/";
        // Remove active class from all icons and panels
        document.querySelectorAll('.sidebar-icon').forEach(i => i.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        
        // Add active class to clicked icon
        this.classList.add('active');
        
        // Show the corresponding panel
        document.getElementById(panelId).classList.add('active');
      });
    });

    // Handle window resize to keep editor working correctly
    window.addEventListener('resize', function() {
      if (editor) {
        editor.layout();
      }
    });
  </script>
</body>
</html>